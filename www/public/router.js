(()=>{function b(e){["link","go"].includes(e)&&window.scrollTo({top:0})}function u(e){let t=new URL(e||window.location.href).href;return t.endsWith("/")||t.includes(".")?t:`${t}/`}function v(e){(!window.history.state||window.history.state.url!==e)&&window.history.pushState({url:e},"internalLink",e)}function y(e){document.querySelector(e).scrollIntoView({behavior:"smooth",block:"start"})}function E(e){let t=u();return{type:"popstate",next:t}}function k(e){let t;if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return{type:"disqualified"};for(let r=e.target;r.parentNode;r=r.parentNode)if(r.nodeName==="A"){t=r;break}if(t&&t.host!==location.host)return t.target="_blank",{type:"external"};if(t&&"cold"in t?.dataset)return{type:"disqualified"};if(t!=null&&t.hasAttribute("href")){let r=t.getAttribute("href"),n=new URL(r,location.href);if(e.preventDefault(),r!=null&&r.startsWith("#"))return y(r),{type:"scrolled"};let o=u(n.href),i=u();return{type:"link",next:o,prev:i}}else return{type:"noop"}}function F(e){return new DOMParser().parseFromString(e,"text/html")}function f(e){document.body.replaceWith(e.body)}function L(e){let t=s=>Array.from(s.querySelectorAll('head>:not([rel="prefetch"]')),r=t(document),n=t(e),{staleNodes:o,freshNodes:i}=x(r,n);o.forEach(s=>s.remove()),document.head.append(...i)}function x(e,t){let r=[],n=[],o=0,i=0;for(;o<e.length||i<t.length;){let s=e[o],l=t[i];if(s!=null&&s.isEqualNode(l)){o++,i++;continue}let a=s?n.findIndex(c=>c.isEqualNode(s)):-1;if(a!==-1){n.splice(a,1),o++;continue}let h=l?r.findIndex(c=>c.isEqualNode(l)):-1;if(h!==-1){r.splice(h,1),i++;continue}s&&r.push(s),l&&n.push(l),o++,i++}return{staleNodes:r,freshNodes:n}}function p(){document.head.querySelectorAll("[data-reload]").forEach(w),document.body.querySelectorAll("script").forEach(w)}function w(e){let t=document.createElement("script"),r=Array.from(e.attributes);for(let{name:n,value:o}of r)t[n]=o;t.append(e.textContent),e.replaceWith(t)}var A={log:!1,pageTransitions:!1},N=class{constructor(e){this.opts=e,this.enabled=!0,this.prefetched=new Set,this.opts={...A,...e??{}},window!=null&&window.history?(document.addEventListener("click",t=>this.onClick(t)),window.addEventListener("popstate",t=>this.onPop(t)),this.prefetch()):(console.warn("flamethrower router not supported in this browser or environment"),this.enabled=!1)}go(e){let t=window.location.href,r=new URL(e,location.origin).href;return this.reconstructDOM({type:"go",next:r,prev:t})}back(){window.history.back()}forward(){window.history.forward()}get allLinks(){return Array.from(document.links).filter(e=>e.href.includes(document.location.origin)&&!e.href.includes("#")&&e.href!==(document.location.href||document.location.href+"/")&&!this.prefetched.has(e.href))}log(...e){this.opts.log&&console.log(...e)}prefetch(){if(this.opts.prefetch==="visible")this.prefetchVisible();else if(this.opts.prefetch==="hover")this.prefetchOnHover();else return}prefetchOnHover(){this.allLinks.forEach(e=>{let t=e.getAttribute("href");e.addEventListener("pointerenter",()=>this.createLink(t),{once:!0})})}prefetchVisible(){let e={root:null,rootMargin:"0px",threshold:1};"IntersectionObserver"in window&&(this.observer||(this.observer=new IntersectionObserver((t,r)=>{t.forEach(n=>{let o=n.target.getAttribute("href");if(this.prefetched.has(o)){r.unobserve(n.target);return}n.isIntersecting&&(this.createLink(o),r.unobserve(n.target))})},e)),this.allLinks.forEach(t=>this.observer.observe(t)))}createLink(e){let t=document.createElement("link");t.rel="prefetch",t.href=e,t.as="document",t.onload=()=>this.log("\u{1F329}\uFE0F prefetched",e),t.onerror=r=>this.log("\u{1F915} can't prefetch",e,r),document.head.appendChild(t),this.prefetched.add(e)}onClick(e){this.reconstructDOM(k(e))}onPop(e){this.reconstructDOM(E())}async reconstructDOM({type:e,next:t,prev:r}){if(!this.enabled){this.log("router disabled");return}try{if(this.log("\u26A1",e),["popstate","link","go"].includes(e)&&t!==r){this.opts.log&&console.time("\u23F1\uFE0F"),window.dispatchEvent(new CustomEvent("flamethrower:router:fetch")),e!="popstate"&&v(t);let n=await(await fetch(t,{headers:{"X-Flamethrower":"1"}}).then(i=>{let s=i.body.getReader(),l=parseInt(i.headers.get("Content-Length")),a=0;return new ReadableStream({start(h){function c(){s.read().then(({done:g,value:d})=>{if(g){h.close();return}a+=d.length,window.dispatchEvent(new CustomEvent("flamethrower:router:fetch-progress",{detail:{progress:Number.isNaN(l)?0:a/l*100,received:a,length:l||0}})),h.enqueue(d),c()})}c()}})}).then(i=>new Response(i,{headers:{"Content-Type":"text/html"}}))).text(),o=F(n);L(o),this.opts.pageTransitions&&document.createDocumentTransition?document.createDocumentTransition().start(()=>{f(o),p()}):(f(o),p()),b(e),window.dispatchEvent(new CustomEvent("flamethrower:router:end")),setTimeout(()=>{this.prefetch()},200),this.opts.log&&console.timeEnd("\u23F1\uFE0F")}}catch(n){return window.dispatchEvent(new CustomEvent("flamethrower:router:error",n)),this.opts.log&&console.timeEnd("\u23F1\uFE0F"),console.error("\u{1F4A5} router fetch failed",n),!1}}},m=e=>{let t=new N(e);if(e.log&&console.log("\u{1F525} flamethrower engaged"),window){let r=window;r.flamethrower=t}return t};m({log:!1,prefetch:"visible",pageTransitions:!1});})();
